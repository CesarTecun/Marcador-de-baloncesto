<div class="scoreboard">
  <div class="scoreboard-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="bi bi-scoreboard me-2"></i>Marcador
    </h5>
    <div *ngIf="isAdmin">
      <button 
        (click)="openAdjustModal()"
        class="btn btn-primary btn-sm adjust-btn"
        [disabled]="!clockRunning"
        [title]="!clockRunning ? 'Inicia el reloj para ajustar la puntuación' : 'Ajustar Puntuación'"
      >
        <i class="bi bi-sliders me-1"></i>Ajustar Puntuación
      </button>
    </div>
  </div>

  <div class="scoreboard-body">
    <!-- Marcador principal -->
    <div class="row align-items-center mb-3">
      <div class="col-5 text-end">
        <div class="fw-bold text-truncate d-inline-flex align-items-center gap-2" [title]="game.homeTeam">
          <img *ngIf="homeLogoUrl" [src]="homeLogoUrl" alt="home logo" style="height:22px;width:22px;object-fit:contain;border-radius:2px;" class="border border-secondary">
          <span>{{ game.homeTeam }}</span>
        </div>
      </div>
      <div class="col-2 text-center">
        <div class="d-flex flex-column align-items-center gap-2">
          <img *ngIf="homeLogoUrl" [src]="homeLogoUrl" alt="home logo" class="scoreboard-logo-lg border border-secondary">
          <div class="display-4 fw-bold score-value">{{ game.homeScore }} - {{ game.awayScore }}</div>
          <img *ngIf="awayLogoUrl" [src]="awayLogoUrl" alt="away logo" class="scoreboard-logo-lg border border-secondary">
        </div>
      </div>
      <div class="col-5">
        <div class="fw-bold text-truncate d-inline-flex align-items-center gap-2" [title]="game.awayTeam">
          <img *ngIf="awayLogoUrl" [src]="awayLogoUrl" alt="away logo" style="height:22px;width:22px;object-fit:contain;border-radius:2px;" class="border border-secondary">
          <span>{{ game.awayTeam }}</span>
        </div>
      </div>
    </div>

    <!-- Estado del partido -->
    <div class="text-center mb-3">
      <span *ngIf="game.status === 'FINISHED'" class="badge bg-danger p-2">
        <i class="bi bi-flag-fill me-1"></i>FINAL
      </span>
      <div *ngIf="game.status !== 'FINISHED'">
        <div class="d-inline-flex gap-3 align-items-center">
          <span class="badge bg-primary p-2">
            <i class="bi bi-123 me-1"></i>Cuarto: {{ game.quarter }}
          </span>
          <span 
            class="badge p-2"
            [ngClass]="game.status === 'IN_PROGRESS' ? 'bg-success' : 'bg-secondary'"
          >
            <i class="bi me-1" [ngClass]="game.status === 'IN_PROGRESS' ? 'bi-play-circle' : 'bi-calendar3'"></i>
            {{ game.status === 'IN_PROGRESS' ? 'EN CURSO' : 'PROGRAMADO' }}
          </span>
        </div>
      </div>
    </div>
    
    <!-- Ganador -->
    <div *ngIf="game.status === 'FINISHED'" class="alert alert-success text-center fw-bold mb-3">
      <i class="bi bi-trophy-fill me-2"></i>{{ getWinner() }}
    </div>

    <!-- Eventos del partido -->
    <div class="mt-4">
      <h6 class="border-bottom pb-2 mb-2 d-flex align-items-center justify-content-between">
        <span>
          <i class="bi bi-list-ul me-2"></i>Eventos del Partido
        </span>
        <button 
          class="btn btn-sm btn-outline-light"
          (click)="toggleEvents()"
          [attr.aria-expanded]="showEvents"
          aria-controls="eventsCollapse"
        >
          <i class="bi" [ngClass]="showEvents ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          {{ showEvents ? 'Ocultar' : 'Mostrar' }} eventos
        </button>
      </h6>
      
      <div *ngIf="showEvents" id="eventsCollapse" class="mt-2">
        <ng-container *ngIf="events?.length; else noEvents">
          <div class="list-group list-group-flush">
            <div *ngFor="let e of events" class="list-group-item bg-transparent text-white border-secondary p-2">
              <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">Q{{ e.quarter }}</span>
                <div class="flex-grow-1">
                  <ng-container [ngSwitch]="e.eventType">
                    <!-- Falta con tipo -->
                    <span *ngSwitchCase="'FOUL'">
                      <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                      Falta
                      <span *ngIf="e.foulType" class="text-warning">({{ e.foulType }})</span>
                      <span *ngIf="e.playerNumber != null" class="text-muted ms-1">
                        #{{ e.playerNumber }}
                      </span>
                    </span>

                    <!-- Otros eventos (incluye ajustes manuales mapeados a etiqueta amigable) -->
                    <span *ngSwitchDefault>
                      <i class="bi bi-info-circle-fill text-info me-1"></i>
                      {{ getEventLabel(e) }}
                      <span *ngIf="e.playerNumber != null" class="text-muted ms-1">
                        #{{ e.playerNumber }}
                      </span>
                    </span>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #noEvents>
          <div class="alert alert-secondary text-center mb-0">
            <i class="bi bi-info-circle me-2"></i>No hay eventos registrados
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Placeholder to restore modal back when closing -->
  <div #modalHost></div>

  <!-- Modal de ajuste de puntuación -->
  <div *ngIf="isAdmin && showAdjustModal" #adjustModalRef class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">
            <i class="bi bi-sliders me-2"></i>Ajustar Puntuación
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="cancelAdjust()"></button>
        </div>
        
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">{{ game.homeTeam }}:</label>
            <div class="input-group">
              <span class="input-group-text">Ajuste</span>
              <input 
                type="number" 
                [(ngModel)]="adjustForm.homeDelta" 
                class="form-control text-end"
                placeholder="+/- puntos"
                [min]="-game.homeScore"
                title="El resultado no puede ser negativo"
              >
              <span class="input-group-text">Nuevo: {{ game.homeScore + (adjustForm.homeDelta || 0) }}</span>
            </div>
            <div *ngIf="(game.homeScore + (adjustForm.homeDelta || 0)) < 0" class="form-text text-danger">
              El puntaje no puede ser negativo.
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">{{ game.awayTeam }}:</label>
            <div class="input-group">
              <span class="input-group-text">Ajuste</span>
              <input 
                type="number" 
                [(ngModel)]="adjustForm.awayDelta" 
                class="form-control text-end"
                placeholder="+/- puntos"
                [min]="-game.awayScore"
                title="El resultado no puede ser negativo"
              >
              <span class="input-group-text">Nuevo: {{ game.awayScore + (adjustForm.awayDelta || 0) }}</span>
            </div>
            <div *ngIf="(game.awayScore + (adjustForm.awayDelta || 0)) < 0" class="form-text text-danger">
              El puntaje no puede ser negativo.
            </div>
          </div>
          
          <div class="alert alert-warning small">
            <i class="bi bi-exclamation-triangle-fill me-1"></i>
            Solo usa esta función para corregir errores en el marcador.
          </div>
        </div>

        <div class="modal-footer">
          <button 
            type="button" 
            class="btn btn-outline-secondary"
            (click)="cancelAdjust()"
          >
            <i class="bi bi-x-circle me-1"></i>Cancelar
          </button>
          <button 
            type="button" 
            class="btn btn-primary"
            (click)="saveAdjust()"
            [disabled]="(game.homeScore + (adjustForm.homeDelta || 0)) < 0 || (game.awayScore + (adjustForm.awayDelta || 0)) < 0"
          >
            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
