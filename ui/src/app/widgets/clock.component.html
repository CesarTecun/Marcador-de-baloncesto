<div class="clock-container position-relative">
  <div class="card shadow-sm h-100">
    <div class="card-header bg-dark text-white py-2">
      <div class="d-flex justify-content-between align-items-center">
        <span class="badge" [ngClass]="{
          'bg-success': status === 'IN_PROGRESS',
          'bg-warning text-dark': status === 'PAUSED',
          'bg-danger': status === 'FINISHED' || status === 'CANCELLED' || status === 'SUSPENDED',
          'bg-primary': status === 'SCHEDULED'
        }">
          {{ getStatusText() }}
        </span>
        <span class="badge" [class.bg-warning]="isOvertime()" [class.text-dark]="isOvertime()">
          <span *ngIf="!isOvertime()">{{ quarter || 1 }}° Cuarto</span>
          <span *ngIf="isOvertime()">T.E. {{ getOvertimeNumber() }}</span>
        </span>
      </div>
    </div>
    
    <div class="card-body text-center p-4 d-flex flex-column">
      <!-- Tiempo principal -->
      <div class="display-1 fw-bold my-auto" 
           [ngClass]="{
             'text-danger': isLast30Seconds(),
             'text-light': !isLast30Seconds()
           }">
        {{ (vmSnap?.remainingMs ?? 0) | msToClock }}
      </div>

      <!-- Mensaje de tiempo extra -->
      <div *ngIf="quarter === 4 && status === 'IN_PROGRESS' && isGameTied() && !isOvertime()" 
           class="alert alert-info text-center my-3 py-2">
        <p class="fw-bold mb-0">¡Empate al final del 4to cuarto!</p>
        <p class="mb-0 small">Presiona "Iniciar T.E." para continuar</p>
      </div>

      <!-- Controles principales -->
      <div class="mt-auto">
        <div class="d-flex flex-wrap justify-content-center gap-2">
          <!-- Botón de Iniciar/Pausar -->
          <button class="btn btn-sm"
                  [class.btn-success]="!vmSnap?.running"
                  [class.btn-warning]="vmSnap?.running"
                  [disabled]="busy || !gameId || status === 'FINISHED'"
                  (click)="toggle()">
            <i class="bi" [class.bi-play-fill]="!vmSnap?.running" [class.bi-pause-fill]="vmSnap?.running"></i>
            {{ vmSnap?.running ? ' Pausar' : ' Iniciar' }}
          </button>
          
          <!-- Botón de Reiniciar -->
          <button class="btn btn-sm btn-secondary"
                  [disabled]="busy || !gameId"
                  (click)="resetQuarter()">
            <i class="bi bi-arrow-clockwise"></i>
            Reiniciar
          </button>
          
          <!-- Botón de Siguiente Cuarto -->
          <button class="btn btn-sm btn-primary"
                  [disabled]="busy || !gameId || status === 'FINISHED'"
                  (click)="advanceQuarter()">
            <i class="bi bi-skip-forward-fill"></i>
            Siguiente
          </button>
        </div>
      </div>
  </div>

  <!-- Controles avanzados (colapsables) -->
  <div class="mt-3 border-t pt-3">
    <div class="flex items-center justify-between mb-2 cursor-pointer" (click)="showAdvanced = !showAdvanced">
      <span class="text-sm font-medium text-gray-600">Controles avanzados</span>
      <span class="text-gray-500">{{ showAdvanced ? '▲' : '▼' }}</span>
    </div>
    
    <div *ngIf="showAdvanced" class="space-y-3 mt-2">
      <!-- Selector de duración -->
      <div class="grid grid-cols-2 gap-2 items-center">
        <label class="text-sm text-gray-600">Duración (min):</label>
        <ng-container *ngIf="(vm$ | async) as vm; else loadingDuration">
          <select class="border rounded p-1 text-sm"
                  [value]="vm.quarterMs / 60000"
                  (change)="setDuration($event)">
            <option value="1">1 minuto (pruebas)</option>
            <option value="5">5 minutos</option>
            <option value="8">8 minutos</option>
            <option value="10" selected>10 minutos</option>
            <option value="12">12 minutos</option>
          </select>
        </ng-container>
        <ng-template #loadingDuration>
          <select class="border rounded p-1 text-sm opacity-50" disabled>
            <option>Cargando...</option>
          </select>
        </ng-template>
      </div>
      
      <!-- Toggle avance automático -->
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-600">Avance automático</span>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" 
                 class="sr-only peer" 
                 [checked]="(vm$ | async)?.autoAdvance"
                 (change)="toggleAutoAdvance($event)">
          <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
        </label>
      </div>
      
      <!-- Botón para avanzar cuarto -->
      <button class="w-full py-1.5 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors"
              (click)="advanceQuarter()"
              [disabled]="busy || !gameId || status === 'FINISHED'">
        Siguiente cuarto
      </button>
    </div>
  </div>

  <!-- Faltas de equipo (solo si está habilitado) -->
  <div *ngIf="showTeamFouls" class="mt-4 pt-3 border-t">
    <div class="text-xs text-gray-500 mb-1">Faltas de equipo:</div>
    <div class="flex justify-around">
      <div class="text-center">
        <div class="text-sm font-medium">LOCAL</div>
        <div class="text-xl font-bold">{{ teamFoulsHome }}</div>
        <div *ngIf="bonusHome" class="text-xs bg-red-100 text-red-800 rounded px-1.5 py-0.5 mt-1">BONUS</div>
      </div>
      <div class="border-l border-gray-200"></div>
      <div class="text-center">
        <div class="text-sm font-medium">VISITANTE</div>
        <div class="text-xl font-bold">{{ teamFoulsAway }}</div>
        <div *ngIf="bonusAway" class="text-xs bg-red-100 text-red-800 rounded px-1.5 py-0.5 mt-1">BONUS</div>
      </div>
    </div>
  </div>
</div>
