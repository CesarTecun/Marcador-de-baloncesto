<div class="p-4 max-w-5xl mx-auto grid gap-4">
  <!-- Filtros -->
  <div class="flex flex-wrap items-center justify-between gap-2">
    <h1 class="text-2xl font-semibold">Resultados</h1>
    <div class="flex flex-wrap gap-2 items-center">
      <label class="text-sm">Estado:</label>
      <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="border rounded px-2 py-1">
        <option value="FINISHED">Finalizados</option>
        <option value="ALL">Todos</option>
        <option value="IN_PROGRESS">En progreso</option>
        <option value="SCHEDULED">Programados</option>
      </select>

      <label class="text-sm ml-3">Buscar equipo:</label>
      <input [(ngModel)]="q" (input)="applyFilters()" placeholder="nombre contiene…" class="border rounded px-2 py-1" />
    </div>
  </div>

  <div class="grid gap-4" style="grid-template-columns: 1fr 2fr;">
    <!-- Lista de partidos -->
    <div class="border rounded p-3">
      <h3 class="font-medium mb-2">Partidos</h3>
      <ul class="divide-y">
        <li *ngFor="let g of filtered" class="py-2 flex items-center justify-between">
          <div>
            <div class="font-semibold">{{ g.homeTeam }} vs {{ g.awayTeam }}</div>
            <div class="text-xs text-gray-500">Q{{ g.quarter }} — {{ g.status }}</div>
          </div>
          <button class="text-blue-600" (click)="view(g)">Ver</button>
        </li>
      </ul>
    </div>

    <!-- Detalle -->
    <div *ngIf="selected as d" class="border rounded p-3">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-lg font-semibold">
            {{ d.game.homeTeam }} {{ d.game.homeScore }} - {{ d.game.awayScore }} {{ d.game.awayTeam }}
          </div>
          <div class="text-xs text-gray-500">Q{{ d.game.quarter }} — {{ d.game.status }}</div>
        </div>

        <!-- BONUS por equipo en el cuarto actual -->
        <div class="text-sm">
          <span class="mr-3">
            HOME Q{{ d.game.quarter }}: {{ (foulSummary?.team | teamFouls:'HOME':d.game.quarter) }}
          </span>
          <span *ngIf="(foulSummary?.team | isBonus:'HOME':d.game.quarter)"
                class="px-2 py-0.5 bg-red-600 text-white rounded">BONUS</span>

          <span class="ml-4 mr-3">
            AWAY Q{{ d.game.quarter }}: {{ (foulSummary?.team | teamFouls:'AWAY':d.game.quarter) }}
          </span>
          <span *ngIf="(foulSummary?.team | isBonus:'AWAY':d.game.quarter)"
                class="px-2 py-0.5 bg-red-600 text-white rounded">BONUS</span>
        </div>
      </div>

      <!-- =================== HOME =================== -->
      <div class="mt-4 border rounded p-2">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Faltas HOME por tipo</div>
          <button class="px-3 py-1 rounded border" (click)="showHomeDetail = !showHomeDetail">
            {{ showHomeDetail ? 'Ocultar detalle HOME' : 'Detalle por jugador (HOME)' }}
          </button>
        </div>

        <!-- Tabla HOME por tipo y por cuarto -->
        <table class="w-full text-sm mt-2">
          <thead>
            <tr class="text-left">
              <th style="width:9rem;">Tipo</th>
              <th *ngFor="let q of quarters" style="text-align:center;">Q{{ q }}</th>
              <th style="text-align:center;">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of foulTypes">
              <td>
                <span class="px-2 py-0.5 rounded text-white"
                      [ngClass]="{
                        'bg-gray-700': t==='PERSONAL',
                        'bg-blue-600': t==='TECHNICAL',
                        'bg-amber-600': t==='UNSPORTSMANLIKE',
                        'bg-red-600': t==='DISQUALIFYING'
                      }">{{ t }}</span>
              </td>
              <td *ngFor="let q of quarters" style="text-align:center;">
                {{ teamFoulsByType('HOME', t, q) }}
              </td>
              <td style="text-align:center; font-weight:600;">
                {{ teamFoulsByTypeTotal('HOME', t) }}
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="font-semibold">
              <td>Total equipo</td>
              <td *ngFor="let q of quarters" style="text-align:center;">
                {{ teamFoulsAllTypesByQuarter('HOME', q) }}
              </td>
              <td style="text-align:center;">
                {{ teamFoulsAllTypesTotal('HOME') }}
              </td>
            </tr>
          </tfoot>
        </table>

        <!-- Detalle HOME por jugador -->
        <div *ngIf="showHomeDetail" class="mt-3 border rounded p-2">
          <div class="font-semibold mb-1">Detalle por jugador — HOME</div>
          <div class="overflow-auto">
            <table class="w-full text-sm min-w-[56rem]">
              <thead>
                <tr class="text-left">
                  <th rowspan="2" style="width:3rem;">#</th>
                  <th rowspan="2">Jugador</th>
                  <ng-container *ngFor="let q of quarters">
                    <th [attr.colspan]="5" style="text-align:center;">Q{{ q }}</th>
                  </ng-container>
                  <th [attr.colspan]="5" style="text-align:center;">Total</th>
                </tr>
                <tr>
                  <ng-container *ngFor="let q of quarters">
                    <th style="text-align:center;">P</th>
                    <th style="text-align:center;">T</th>
                    <th style="text-align:center;">U</th>
                    <th style="text-align:center;">D</th>
                    <th style="text-align:center;">Tot</th>
                  </ng-container>
                  <th style="text-align:center;">P</th>
                  <th style="text-align:center;">T</th>
                  <th style="text-align:center;">U</th>
                  <th style="text-align:center;">D</th>
                  <th style="text-align:center;">Tot</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of homeRoster">
                  <td>{{ p.number ?? '—' }}</td>
                  <td>{{ p.name }}</td>

                  <ng-container *ngFor="let q of quarters">
                    <td style="text-align:center;">{{ playerFoulsByTypeQ('HOME', p.playerId, 'PERSONAL',        q) }}</td>
                    <td style="text-align:center;">{{ playerFoulsByTypeQ('HOME', p.playerId, 'TECHNICAL',       q) }}</td>
                    <td style="text-align:center;">{{ playerFoulsByTypeQ('HOME', p.playerId, 'UNSPORTSMANLIKE', q) }}</td>
                    <td style="text-align:center;">{{ playerFoulsByTypeQ('HOME', p.playerId, 'DISQUALIFYING',   q) }}</td>
                    <td style="text-align:center; font-weight:600;">{{ playerFoulsQuarterTotal('HOME', p.playerId, q) }}</td>
                  </ng-container>

                  <td style="text-align:center;">{{ playerFoulsTotalByType('HOME', p.playerId, 'PERSONAL') }}</td>
                  <td style="text-align:center;">{{ playerFoulsTotalByType('HOME', p.playerId, 'TECHNICAL') }}</td>
                  <td style="text-align:center;">{{ playerFoulsTotalByType('HOME', p.playerId, 'UNSPORTSMANLIKE') }}</td>
                  <td style="text-align:center;">{{ playerFoulsTotalByType('HOME', p.playerId, 'DISQUALIFYING') }}</td>
                  <td style="text-align:center; font-weight:600;">{{ playerFoulsTotalAll('HOME', p.playerId) }}</td>
                </tr>

                <!-- Equipo (sin asignar) -->
                <tr class="bg-gray-50">
                  <td>—</td>
                  <td class="font-medium italic">Equipo (sin asignar)</td>
                  <ng-container *ngFor="let q of quarters">
                    <td style="text-align:center;">{{ unassignedByTypeQ('HOME', 'PERSONAL',        q) }}</td>
                    <td style="text-align:center;">{{ unassignedByTypeQ('HOME', 'TECHNICAL',       q) }}</td>
                    <td style="text-align:center;">{{ unassignedByTypeQ('HOME', 'UNSPORTSMANLIKE', q) }}</td>
                    <td style="text-align:center;">{{ unassignedByTypeQ('HOME', 'DISQUALIFYING',   q) }}</td>
                    <td style="text-align:center; font-weight:600;">{{ unassignedQuarterTotal('HOME', q) }}</td>
                  </ng-container>
                  <td style="text-align:center;">{{ unassignedTotalByType('HOME', 'PERSONAL') }}</td>
                  <td style="text-align:center;">{{ unassignedTotalByType('HOME', 'TECHNICAL') }}</td>
                  <td style="text-align:center;">{{ unassignedTotalByType('HOME', 'UNSPORTSMANLIKE') }}</td>
                  <td style="text-align:center;">{{ unassignedTotalByType('HOME', 'DISQUALIFYING') }}</td>
                  <td style="text-align:center; font-weight:600;">{{ unassignedTotalAll('HOME') }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- =================== AWAY =================== -->
      <div class="mt-4 border rounded p-2">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Faltas AWAY por tipo</div>
          <button class="px-3 py-1 rounded border" (click)="showAwayDetail = !showAwayDetail">
            {{ showAwayDetail ? 'Ocultar detalle AWAY' : 'Detalle por jugador (AWAY)' }}
          </button>
        </div>

        <!-- Tabla AWAY por tipo y por cuarto -->
        <table class="w-full text-sm mt-2">
          <thead>
            <tr class="text-left">
              <th style="width:9rem;">Tipo</th>
              <th *ngFor="let q of quarters" style="text-align:center;">Q{{ q }}</th>
              <th style="text-align:center;">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of foulTypes">
              <td>
                <span class="px-2 py-0.5 rounded text-white"
                      [ngClass]="{
                        'bg-gray-700': t==='PERSONAL',
                        'bg-blue-600': t==='TECHNICAL',
                        'bg-amber-600': t==='UNSPORTSMANLIKE',
                        'bg-red-600': t==='DISQUALIFYING'
                      }">{{ t }}</span>
              </td>
              <td *ngFor="let q of quarters" style="text-align:center;">
                {{ teamFoulsByType('AWAY', t, q) }}
              </td>
              <td style="text-align:center; font-weight:600;">
                {{ teamFoulsByTypeTotal('AWAY', t) }}
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="font-semibold">
              <td>Total equipo</td>
              <td *ngFor="let q of quarters" style="text-align:center;">
                {{ teamFoulsAllTypesByQuarter('AWAY', q) }}
              </td>
              <td style="text-align:center;">
                {{ teamFoulsAllTypesTotal('AWAY') }}
              </td>
            </tr>
          </tfoot>
        </table>

        <!-- Detalle AWAY por jugador -->
        <div *ngIf="showAwayDetail" class="mt-3 border rounded p-2">
          <div class="font-semibold mb-1">Detalle por jugador — AWAY</div>
          <div class="overflow-auto">
            <table class="w-full text-sm min-w-[56rem]">
              <thead>
                <tr class="text-left">
                  <th rowspan="2" style="width:3rem;">#</th>
                  <th rowspan="2">Jugador</th>
                  <ng-container *ngFor="let q of quarters">
                    <th [attr.colspan]="5" style="text-align:center;">Q{{ q }}</th>
                  </ng-container>
                  <th [attr.colspan]="5" style="text-align:center;">Total</th>
                </tr>
                <tr>
                  <ng-container *ngFor="let q of quarters">
                    <th style="text-align:center;">P</th>
                    <th style="text-align:center;">T</th>
                    <th style="text-align:center;">U</th>
                    <th style="text-align:center;">D</th>
                    <th style="text-align:center;">Tot</th>
                  </ng-container>
                  <th style="text-align:center;">P</th>
                  <th style="text-align:center;">T</th>
                  <th style="text-align:center;">U</th>
                  <th style="text-align:center;">D</th>
                  <th style="text-align:center;">Tot</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of awayRoster">
                  <td>{{ p.number ?? '—' }}</td>
                  <td>{{ p.name }}</td>

                  <ng-container *ngFor="let q of quarters">
                    <td style="text-align:center;">{{ playerFoulsByTypeQ('AWAY', p.playerId, 'PERSONAL',        q) }}</td>
                    <td style="text-align:center;">{{ playerFoulsByTypeQ('AWAY', p.playerId, 'TECHNICAL',       q) }}</td>
                    <td style="text-align:center;">{{ playerFoulsByTypeQ('AWAY', p.playerId, 'UNSPORTSMANLIKE', q) }}</td>
                    <td style="text-align:center;">{{ playerFoulsByTypeQ('AWAY', p.playerId, 'DISQUALIFYING',   q) }}</td>
                    <td style="text-align:center; font-weight:600;">{{ playerFoulsQuarterTotal('AWAY', p.playerId, q) }}</td>
                  </ng-container>

                  <td style="text-align:center;">{{ playerFoulsTotalByType('AWAY', p.playerId, 'PERSONAL') }}</td>
                  <td style="text-align:center;">{{ playerFoulsTotalByType('AWAY', p.playerId, 'TECHNICAL') }}</td>
                  <td style="text-align:center;">{{ playerFoulsTotalByType('AWAY', p.playerId, 'UNSPORTSMANLIKE') }}</td>
                  <td style="text-align:center;">{{ playerFoulsTotalByType('AWAY', p.playerId, 'DISQUALIFYING') }}</td>
                  <td style="text-align:center; font-weight:600;">{{ playerFoulsTotalAll('AWAY', p.playerId) }}</td>
                </tr>

                <!-- Equipo (sin asignar) -->
                <tr class="bg-gray-50">
                  <td>—</td>
                  <td class="font-medium italic">Equipo (sin asignar)</td>
                  <ng-container *ngFor="let q of quarters">
                    <td style="text-align:center;">{{ unassignedByTypeQ('AWAY', 'PERSONAL',        q) }}</td>
                    <td style="text-align:center;">{{ unassignedByTypeQ('AWAY', 'TECHNICAL',       q) }}</td>
                    <td style="text-align:center;">{{ unassignedByTypeQ('AWAY', 'UNSPORTSMANLIKE', q) }}</td>
                    <td style="text-align:center;">{{ unassignedByTypeQ('AWAY', 'DISQUALIFYING',   q) }}</td>
                    <td style="text-align:center; font-weight:600;">{{ unassignedQuarterTotal('AWAY', q) }}</td>
                  </ng-container>
                  <td style="text-align:center;">{{ unassignedTotalByType('AWAY', 'PERSONAL') }}</td>
                  <td style="text-align:center;">{{ unassignedTotalByType('AWAY', 'TECHNICAL') }}</td>
                  <td style="text-align:center;">{{ unassignedTotalByType('AWAY', 'UNSPORTSMANLIKE') }}</td>
                  <td style="text-align:center;">{{ unassignedTotalByType('AWAY', 'DISQUALIFYING') }}</td>
                  <td style="text-align:center; font-weight:600;">{{ unassignedTotalAll('AWAY') }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Eventos -->
      <h4 class="mt-4 font-semibold">Eventos recientes</h4>
      <ul class="text-sm divide-y" style="max-height:16rem; overflow:auto;">
        <li *ngFor="let e of d.events" class="py-1">
          {{ e.createdAt | date:'short' }} — {{ e.eventType }}
          <ng-container *ngIf="e.team">({{ e.team }})</ng-container>
          <ng-container *ngIf="e.playerNumber != null"> #{{ e.playerNumber }}</ng-container>
          <ng-container *ngIf="e.playerId != null"> (id: {{ e.playerId }})</ng-container>

          <ng-container *ngIf="e.eventType === 'FOUL'">
            <span class="ml-2 px-2 py-0.5 rounded text-white"
                  [ngClass]="{
                    'bg-gray-700': (e.foulType || 'PERSONAL')==='PERSONAL',
                    'bg-blue-600': e.foulType==='TECHNICAL',
                    'bg-amber-600': e.foulType==='UNSPORTSMANLIKE',
                    'bg-red-600': e.foulType==='DISQUALIFYING'
                  }">
              {{ (e.foulType || 'PERSONAL') }}
            </span>
          </ng-container>
        </li>
      </ul>
    </div>
  </div>
</div>
