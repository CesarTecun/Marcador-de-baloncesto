<div class="container-fluid py-4">
  <!-- Aviso cuando no hay sesión -->
  <div class="row mb-3" *ngIf="!isAuthed()">
    <div class="col-12">
      <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
          <i class="bi bi-info-circle me-2"></i>
          Acciones administrativas ocultas. Inicia sesión para crear partidos, registrar equipos y administrar el marcador.
        </div>
        <a class="btn btn-sm btn-primary" routerLink="/login">
          <i class="bi bi-box-arrow-in-right me-1"></i> Ir a Iniciar sesión
        </a>
      </div>
    </div>
  </div>
  <!-- Acciones principales: Actualizar + Tema -->
  <div class="row mb-3">
    <div class="col-12 d-flex justify-content-center gap-2">
      <div class="card shadow-sm" style="width: fit-content;">
        <div class="card-body p-1">
          <button class="btn btn-primary" (click)="reloadAll()" style="min-width: 150px;">
            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
          </button>
        </div>
      </div>
      <div class="card shadow-sm" style="width: fit-content;">
        <div class="card-body p-1">
          <app-theme-toggle size="sm"></app-theme-toggle>
        </div>
      </div>
      <!-- Cerrar sesión -->
      <div class="card shadow-sm" style="width: fit-content;" *ngIf="isAuthed()">
        <div class="card-body p-1">
          <button class="btn btn-outline-danger" (click)="logout()" style="min-width: 150px;">
            <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Layout -->
  <div class="row">
    <!-- ===== SIDEBAR (sticky) ===== -->
    <div class="col-lg-4 col-xl-3 mb-4">
      <div class="position-sticky d-flex flex-column gap-3" style="top:16px; z-index:10;">
        <!-- 1) NUEVO PARTIDO (FIJO) -->
        <div class="card shadow-sm" *ngIf="isAuthed()">
          <div class="card-header header-contrast-high">
            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Nuevo Partido</h6>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <label class="form-label">Equipo Local</label>
              <select #homeSel class="form-select form-select-sm">
                <option [ngValue]="0" class="text-muted">Seleccionar equipo local…</option>
                <option *ngFor="let t of teams" [value]="t.teamId">{{ t.name }} ({{ t.teamId }})</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Equipo Visitante</label>
              <select #awaySel class="form-select form-select-sm">
                <option [ngValue]="0" class="text-muted">Seleccionar equipo visitante…</option>
                <option *ngFor="let t of teams" [value]="t.teamId">{{ t.name }} ({{ t.teamId }})</option>
              </select>
            </div>
            <button
              class="btn btn-success w-100"
              [disabled]="creating || !homeSel.value || !awaySel.value || homeSel.value === awaySel.value"
              (click)="createGame(+homeSel.value, +awaySel.value)">
              <i class="bi bi-plus-circle me-1"></i>{{ creating ? 'Creando…' : 'Crear Partido' }}
            </button>
          </div>
        </div>

        <!-- 2) REGISTRAR EQUIPO (FIJO) -->
        <div class="card shadow-sm" *ngIf="isAuthed()">
          <div class="card-header header-contrast-high">
            <h6 class="mb-0"><i class="bi bi-people me-2"></i>Registrar Nuevo Equipo</h6>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-12">
                <label for="teamName" class="form-label">Nombre del Equipo</label>
                <input id="teamName" type="text" class="form-control"
                     [(ngModel)]="newTeamName" 
                     (input)="onTeamNameInput($event)"
                     pattern="[A-Za-záéíóúÁÉÍÓÚüÜñÑ\s]+"
                     title="Solo se permiten letras y espacios"
                     placeholder="Ingrese el nombre del equipo…"
                     #teamNameInput="ngModel"
                     [ngClass]="{'is-invalid': (teamNameInput.invalid && teamNameInput.touched) || showInvalidCharWarning}">
              
              <!-- Mensaje de error para validación de patrón -->
              <div *ngIf="teamNameInput.invalid && teamNameInput.touched" class="invalid-feedback">
                Solo se permiten letras y espacios en el nombre del equipo.
              </div>
              
              <!-- Mensaje de error en tiempo real -->
              <div *ngIf="showInvalidCharWarning" class="text-warning small mt-1">
                <i class="bi bi-exclamation-triangle-fill"></i> Solo se permiten letras y espacios. Los números y caracteres especiales no están permitidos.
              </div>
                <div class="form-text">Debe ser único y descriptivo.</div>
              </div>
              <!-- Ciudad del equipo (opcional) -->
              <div class="col-12">
                <label class="form-label">Ciudad (opcional)</label>
                <input type="text" class="form-control"
                       [(ngModel)]="newTeamCity"
                       placeholder="Ej. Guatemala">
              </div>
              <!-- Logo del equipo (opcional) -->
              <div class="col-12">
                <label class="form-label">Logo (PNG/JPG/WEBP, máx 2MB)</label>
                <input type="file" class="form-control"
                       (change)="onTeamFileSelected($event)"
                       accept="image/png,image/jpeg,image/jpg,image/webp">
                <div *ngIf="newTeamLogoPreview" class="text-center mt-2">
                  <img [src]="newTeamLogoPreview" alt="Vista previa logo" class="img-thumbnail" style="max-height: 140px;">
                </div>
              </div>
              <div class="col-12 d-grid">
                <button class="btn btn-success"
                        [disabled]="creating || !newTeamName.trim()"
                        (click)="createTeam()">
                  <i class="bi bi-plus-circle me-1"></i>{{ creating ? 'Procesando…' : 'Registrar Equipo' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 3) ESTADO (COMPACTO) -->
        <div *ngIf="detail as d" class="card shadow-sm">
          <div class="card-header header-contrast-high d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-activity me-2"></i>Estado del Partido</h6>
            <span class="badge px-2 py-1"
                  [ngClass]="{
                    'bg-success bg-opacity-10 text-success': d.game.status === 'IN_PROGRESS',
                    'bg-danger  bg-opacity-10 text-danger' : d.game.status === 'FINISHED' || d.game.status === 'CANCELLED',
                    'bg-warning bg-opacity-10 text-warning': d.game.status === 'SUSPENDED',
                    'bg-info    bg-opacity-10 text-info'   : d.game.status === 'SCHEDULED'
                  }">
              <i class="bi me-1"
                 [ngClass]="{
                   'bi-play-circle': d.game.status === 'IN_PROGRESS',
                   'bi-flag'       : d.game.status === 'FINISHED',
                   'bi-x-circle'   : d.game.status === 'CANCELLED',
                   'bi-pause-circle': d.game.status === 'SUSPENDED',
                   'bi-calendar3'  : d.game.status === 'SCHEDULED'
                 }"></i>
              {{
                d.game.status === 'IN_PROGRESS' ? 'EN PROGRESO' :
                d.game.status === 'FINISHED'    ? 'FINALIZADO'  :
                d.game.status === 'CANCELLED'   ? 'CANCELADO'   :
                d.game.status === 'SUSPENDED'   ? 'SUSPENDIDO'  :
                                                  'PROGRAMADO'
              }}
            </span>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button *ngIf="d.game.status === 'IN_PROGRESS'"
                      class="btn btn-warning btn-sm"
                      [disabled]="!isAuthed()"
                      (click)="suspendGame(d.game.gameId)">
                <i class="bi bi-pause-circle me-1"></i> Suspender
              </button>
              <button *ngIf="d.game.status === 'SUSPENDED'"
                      class="btn btn-success btn-sm"
                      [disabled]="!isAuthed()"
                      (click)="resumeGame(d.game.gameId)">
                <i class="bi bi-play-circle me-1"></i> Reanudar
              </button>
              <button *ngIf="d.game.status === 'SCHEDULED'"
                      class="btn btn-success btn-sm"
                      [disabled]="!isAuthed()"
                      (click)="startGame(d.game.gameId)">
                <i class="bi bi-play-fill me-1"></i> Iniciar
              </button>
              <button *ngIf="d.game.status !== 'FINISHED' && d.game.status !== 'CANCELLED'"
                      class="btn btn-outline-danger btn-sm"
                      [disabled]="!isAuthed()"
                      (click)="cancelGame(d.game.gameId)">
                <i class="bi bi-x-circle me-1"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
        <!-- OJO: ya no renderizamos app-control-panel en el sidebar; ahora va ancho en el main -->
      </div>
    </div>

    <!-- ===== MAIN CONTENT ===== -->
    <div class="col-lg-8 col-xl-9">
      <!-- Juegos activos / programados -->
      <div class="row mb-4" *ngIf="activeGames.length > 0">
        <div class="col-12">
            <div class="card shadow-sm border-0">
            <div class="card-header header-contrast-high">
              <h5 class="card-title mb-0">
                <i class="bi bi-controller me-2"></i>
                {{ hasActiveGames() ? 'Juegos Activos' : 'Juegos Programados' }}
              </h5>
            </div>
            <div class="card-body p-0">
              <div class="list-group list-group-flush">
                <div *ngFor="let game of activeGames"
                     class="list-group-item list-group-item-action"
                     (click)="selectGame(game)">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1 fw-bold">
                        {{ game.homeTeam }} <span class="text-muted">vs</span> {{ game.awayTeam }}
                      </h6>
                      <div class="d-flex align-items-center">
                        <span class="badge me-2"
                              [ngClass]="{
                                'bg-success' : game.status === 'IN_PROGRESS',
                                'bg-secondary': game.status === 'SCHEDULED',
                                'bg-danger'  : game.status === 'FINISHED' || game.status === 'CANCELLED',
                                'bg-warning' : game.status === 'SUSPENDED'
                              }">
                          {{
                            game.status === 'IN_PROGRESS' ? 'EN CURSO' :
                            game.status === 'FINISHED'    ? 'FINALIZADO' :
                            game.status === 'CANCELLED'   ? 'CANCELADO'  :
                            game.status === 'SUSPENDED'   ? 'SUSPENDIDO' :
                                                             'PROGRAMADO'
                          }}
                        </span>
                        <small class="text-muted">
                          <span *ngIf="game.status !== 'SCHEDULED'">Q{{ game.quarter }} • </span>
                          <span *ngIf="game.homeScore !== undefined && game.awayScore !== undefined">
                            {{ game.homeScore }} - {{ game.awayScore }}
                          </span>
                        </small>
                      </div>
                    </div>
                    <button class="btn btn-sm" *ngIf="isAuthed()"
                            [ngClass]="game.status === 'SCHEDULED' ? 'btn-outline-primary' : 'btn-primary'"
                            (click)="$event.stopPropagation(); selectGame(game)">
                      <i class="bi" [ngClass]="game.status === 'SCHEDULED' ? 'bi-gear' : 'bi-speedometer2'"></i>
                      {{ game.status === 'SCHEDULED' ? 'Configurar' : 'Administrar' }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Últimos partidos y equipos -->
      <div class="row">
        <div class="col-12 col-xxl-6 mb-4">
          <div class="card shadow-sm h-100">
            <div class="card-header header-contrast-high">
              <h5 class="card-title mb-0"><i class="bi bi-list-ul me-2"></i>Últimos Partidos</h5>
            </div>
            <div class="card-body p-0">
              <div class="list-group list-group-flush">
                <a *ngFor="let g of games | slice:0:10"
                   [routerLink]="isAuthed() ? ['/display', g.gameId] : null"
                   (click)="!isAuthed() ? $event.preventDefault() : null"
                   [attr.aria-disabled]="!isAuthed()"
                   [class.disabled]="!isAuthed()"
                   class="list-group-item list-group-item-action">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-medium">{{ g.homeTeam }} vs {{ g.awayTeam }}</div>
                      <small class="text-muted">
                        <span class="badge bg-light text-dark me-1">Q{{ g.quarter }}</span>
                        <span class="text-capitalize">{{ g.status.toLowerCase() }}</span>
                      </small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary"
                            [disabled]="!isAuthed()"
                            [routerLink]="isAuthed() ? ['/results'] : null" [queryParams]="{ id: g.gameId }"
                            (click)="$event.stopPropagation()">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                </a>
                <div *ngIf="games.length === 0" class="p-3 text-center text-muted">No hay partidos recientes</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-xxl-6 mb-4">
          <div class="card shadow-sm h-100">
            <div class="card-header header-contrast-high d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0"><i class="bi bi-people me-2"></i>Equipos Registrados</h5>
              <div class="input-group" style="max-width:280px;">
                <input type="text" class="form-control form-control-sm" placeholder="Buscar equipo…"
                       [(ngModel)]="teamSearch">
                <button class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-search"></i></button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead>
                    <tr><th>ID</th><th>Nombre del Equipo</th><th class="text-end">Acciones</th></tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let t of teams | filter:teamSearch:'name' | slice:0:10">
                      <td class="text-muted">#{{ t.teamId }}</td>
                      <td class="fw-medium">{{ t.name }}</td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger ms-1"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                    <tr *ngIf="teams.length === 0">
                      <td colspan="3" class="text-center text-muted py-3">No hay equipos registrados</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

<!-- ===== DETALLE: MARCADOR + RELOJ (arriba) / CONTROL PANELS (abajo) ===== -->
<div *ngIf="detail as d" class="col-12">
  <div class="row g-3" *ngIf="isAuthed()">
    <!-- Fila 1: Marcador (izq) + Reloj (der) -->
    <div class="col-12 col-xl-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body p-2">
          <app-scoreboard
            [game]="d.game"
            [events]="d.events"
            [isAdmin]="isAuthed()"
            (adjustScore)="onAdjustScore($event)">
          </app-scoreboard>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-stopwatch me-2"></i>Reloj del Partido</h6>
        </div>
        <div class="card-body">
          <app-clock
            *ngIf="d.game.status === 'IN_PROGRESS' || d.game.status === 'SUSPENDED'"
            [gameId]="d.game.gameId"
            [status]="d.game.status"
            [quarter]="d.game.quarter"
            [homeScore]="d.game.homeScore"
            [awayScore]="d.game.awayScore"
            [showTeamFouls]="false"
            [canEdit]="isAuthed()"
            [(autoAdvance)]="autoAdvanceEnabled"
            (advanceQuarter)="onExpire()"
            (resetGame)="onResetGame()">
          </app-clock>
        </div>
      </div>
    </div>
  </div>

  <!-- Fila 2: Control Panels lado a lado -->
  <div class="row g-3 mt-1">
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header header-contrast-high">
          <h6 class="mb-0"><i class="bi bi-sliders me-2"></i>Control Panel - LOCAL</h6>
        </div>
        <div class="card-body">
          <app-control-panel
            [game]="d.game"
            side="HOME"
            [isSuspended]="d.game.status === 'SUSPENDED'"
            [canEdit]="isAuthed()"
            (changed)="view(d.game.gameId)"
            (resetRequested)="onResetRequested()">
          </app-control-panel>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header header-contrast-high">
          <h6 class="mb-0"><i class="bi bi-sliders me-2"></i>Control Panel - VISITANTE</h6>
        </div>
        <div class="card-body">
          <app-control-panel
            [game]="d.game"
            side="AWAY"
            [isSuspended]="d.game.status === 'SUSPENDED'"
            [canEdit]="isAuthed()"
            (changed)="view(d.game.gameId)"
            (resetRequested)="onResetRequested()">
          </app-control-panel>
        </div>
      </div>
    </div>
  </div>

  <!-- Fila 3: Rosters debajo -->
  <div class="row g-3 mt-1">
    <div class="col-md-6">
      <app-team-roster [gameId]="d.game.gameId" side="HOME" [canEdit]="isAuthed()"></app-team-roster>
    </div>
    <div class="col-md-6">
      <app-team-roster [gameId]="d.game.gameId" side="AWAY" [canEdit]="isAuthed()"></app-team-roster>
    </div>
  </div>
</div>
<!-- ===== /DETALLE ===== -->